name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Download source tarball and compute SHA256
        id: sha
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          curl -fSL -o source.tar.gz "https://github.com/backmeupplz/drumkit/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz"
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"

      - name: Generate formula
        run: |
          TAG="${{ github.event.release.tag_name }}"
          SHA256="${{ steps.sha.outputs.sha256 }}"
          mkdir -p Formula
          cat > Formula/drumkit.rb << EOF
          class Drumkit < Formula
            desc "Low-latency TUI MIDI drum sampler for electronic drum kits"
            homepage "https://github.com/backmeupplz/drumkit"
            url "https://github.com/backmeupplz/drumkit/archive/refs/tags/${TAG}.tar.gz"
            sha256 "${SHA256}"
            license "MIT"

            depends_on "rust" => :build

            def install
              system "cargo", "install", "--locked", "--root", prefix, "--path", "."
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/drumkit --version")
            end
          end
          EOF
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' Formula/drumkit.rb

      - name: Push formula to tap
        env:
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          git clone "https://x-access-token:${TAP_TOKEN}@github.com/backmeupplz/homebrew-drumkit.git" tap
          mkdir -p tap/Formula
          cp Formula/drumkit.rb tap/Formula/drumkit.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/drumkit.rb
          git commit -m "Update drumkit to ${{ steps.version.outputs.version }}"
          git push
